<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>js promise实现</title>
</head>

<body>

</body>
<script>
    var person = new Promise((resolve, reject) => {
        setTimeout(() => {
            resolve('a')
        }, 1000)
    })
    var a = person.then();
    console.log('a', a)
    /**
     * Promise实现
     * 1.如何让Promise变成一个微任务
     * 2.如何管理Promise的状态
     * 3.then方法的返回值问题
     * 4.静态方法: resolve 、reject、all、race
     * */
    function _Promise(callback) {
        if (typeof callback !== 'function') {
            throw new TypeError('Promise resolver undefined is not a function')
        } else {
            // 调用回调函数
            callback(this._resolve, this._rejecte)
        }
    }
    // 定义变量
    _Promise.prototype.initStatus = 'PENDING';

    _Promise.prototype._value = [];

    _Promise.prototype.resolveQueues = [];
    _Promise.prototype.rejectQueues = [];
    // 初始化回调函数
    function initCallBack(vm) {
        vm.prototype._resolve = function (resolve) {
            window.addEventListener('message', () => {
                vm.prototype._value.push(resolve);
                // 更改成功状态
                if (vm.prototype.initStatus == 'PENDING') {
                    vm.prototype.initStatus = 'FULFILED';
                }
                vm.prototype.resolveQueues.forEach(fn => {
                    vm.prototype._value.forEach((item) => {
                        fn(item)
                    })
                });
            })
            window.postMessage('')
        }
        vm.prototype._rejecte = function (reject) {
            window.addEventListener('message', () => {
                vm.prototype._value.push(reject);
                // 更改失败状态
                if (vm.prototype.initStatus == 'PENDING') {
                    vm.prototype.initStatus = 'REJECTED';
                }
                var rejectCallBack = vm.prototype.rejectQueues[0];
                rejectCallBack(vm.prototype._value)
            })
            window.postMessage('')
        }
    }
    // 初始化then方法
    function initThen(vm) {
        vm.prototype._then = function (resolveCallBack, rejectCallBack) {
            return new _Promise((resolve, reject) => {
                vm.prototype.resolveQueues.push(resolveCallBack);
                vm.prototype.rejectQueues.push(rejectCallBack);
            })
        }
    }
    initCallBack(_Promise);
    initThen(_Promise);

    new _Promise((resolve, reject) => {
        setTimeout(function () {
            resolve('结果')
        }, 1000)
    })._then((res) => {
        console.log('1');
        return '3'
    })._then((res) => {
        console.log('2', res)
    });
</script>

</html>